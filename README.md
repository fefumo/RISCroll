# RISCroll
```
                                       ____________________________
                                      /                           /\
                                     /                           / /\ 
                                    /     =================     / /
                                   /     /    RISC-V      /   / \/
                                  /     /    32-bit      /    /\
                                 /     /================/    / /
                                /___________________________/ /
                                \___________________________\/
                                 \ \ \ \ \ \ \ \ \ \ \ \ \ \ \
```
–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ4. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç

–ú–æ–ª—á–∞–Ω–æ–≤ –§—ë–¥–æ—Ä –î–µ–Ω–∏—Å–æ–≤–∏—á, P3213
`asm | risc | harv | mc | tick | binary | stream | mem | pstr | prob2 | vector`

## –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
### –°–∏–Ω—Ç–∞–∫—Å–∏—Å

```ebnf
<program>         ::= {<line> | <macro_def>}

<line>            ::= <label_line> | <code_line> | <comment_line>

<label_line>      ::= <label> [<comment>] <newline>

<code_line>       ::= [<label>] (<instruction> | <directive> | <macro_use>) [<comment>] <newline>

<comment_line>    ::= <comment> <newline>

<label>           ::= <identifier> ":"

<directive>       ::= "." <identifier> [<value_list>]

<value_list>      ::= <value> { "," <value> }

<value>           ::= <identifier> 
                        | <number> 
                        | <string>
                        | "high(" <identifier> ")"
                        | "low(" <identifier> ")"

<string>          ::= '"' { <any_char_except_quote> } '"'

<instruction>     ::= <r_type_instr>
                        | <i_arith_instr>
                        | <i_load_instr>
                        | <i_jump_instr>
                        | <s_type_instr>
                        | <b_type_instr>
                        | <u_type_instr>
                        | <j_type_instr>
                        | <sys_instr>

<r_type_instr>    ::= ("add" | "sub" | "mul" | "div" | "lsl" | "lsr" | "and" | "or" | "xor")
                     <reg> "," <reg> "," <reg>

<i_arith_instr> ::= ("addi" | "andi" | "ori")
                    <reg> "," <reg> "," <immediate>

<i_load_instr>  ::= "lw"
                    <reg> "," <offset> "(" <reg> ")"

<i_jump_instr>  ::= "jalr"
                    <reg> "," <offset> "(" <reg> ")"


<s_type_instr>    ::= ("sw") <reg> "," <offset> "(" <reg> ")"

<b_type_instr>    ::= ("beq" | "bne" | "bgt" | "ble" | )  <reg> "," <reg> "," <label_ref>

<u_type_instr>    ::= ("lui" | "auipc") <reg> "," <immediate>

<sys_instr>       ::= "halt"

<j_type_instr>    ::= "jal" <reg> "," <label_ref>

<comment>         ::= "#" { <any_char_except_newline> }

<reg>             ::= "$r" <number>         // $r0 to $r31

<offset>          ::= <number>
<immediate>       ::= <number>
<label_ref>       ::= <identifier>

<identifier>      ::= <letter> { <letter> | <digit> | "_" }

<number> ::= ["-"] (<decimal> | <hexadecimal>)

<decimal>     ::= <digit> {<digit>}
<hexadecimal> ::= "0x" <hex_digit> {<hex_digit>}

<hex_digit>   ::= <digit> | "a" | "b" | "c" | "d" | "e" | "f"
                             | "A" | "B" | "C" | "D" | "E" | "F"

<letter>          ::= "A" | ... | "Z" | "a" | ... | "z"
<digit>           ::= "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"

<macro_def> ::= ".macro" <identifier> [<macro_param_list>] <newline>
                { <line> }
                ".endm" <newline>

<macro_param_list> ::= <identifier> { "," <identifier> }

<macro_use> ::= <identifier> [<macro_arg_list>]

<macro_arg_list> ::= <value> { "," <value> }

```
##### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ label-–æ–≤, —Å–µ–∫—Ü–∏–π –∏ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã .org.
–û–ø–∏—Å–∞–Ω–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∏—Å–∞—Ç—å –∫–æ–¥ –∫–∞–∫ –Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–º –∞—Å–º–µ.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–µ–π–±–ª–æ–≤, —Å–µ–∫—Ü–∏–π –∏ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã .org:
```
.data
.org 0x0200
in_addr: .word 0x100

.text
.org 0x1000
main:
    halt
```


inc3 r5 # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞–∫—Ä–æ—Å–∞ inc3 –≤ –∫–æ–¥–µ

```
### –†–µ–≥–∏—Å—Ç—Ä—ã
| Register | Alias  | Description                       |
|----------|--------|-----------------------------------|
| `r0`    | `zero` | Constant zero                     |
| `r1`    | `ra`   | Return address                    |
| `r2`    | `sp`   | Stack pointer                     |
| `r3`    | `gp`   | Global pointer (optional)         |
| `r4`    | `tp`   | Thread pointer (optional)         |
| `r5`    | `t0`   | Temporary                         |
| `r6`    | `t1`   | Temporary                         |
| `r7`    | `t2`   | Temporary                         |
| `r8`    | `s0`   | Saved register / frame pointer    |
| `r9`    | `s1`   | Saved register                    |
| `r10`   | `s2`   | Saved register                    |
| `r11`   | `s3`   | Saved register                    |
| `r12`   | `s4`   | Saved register                    |
| `r13`   | `s5`   | Saved register                    |
| `r14`   | `s6`   | Saved register                    |
| `r15`   | `s7`   | Saved register                    |
| `r16`   | `a0`   | Function argument / syscall return |
| `r17`   | `a1`   | Function argument                 |
| `r18`   | `a2`   | Function argument                 |
| `r19`   | `a3`   | Function argument                 |
| `r20`   | `a4`   | Function argument                 |
| `r21`   | `a5`   | Function argument                 |
| `r22`   | `a6`   | Function argument                 |
| `r23`   | `a7`   | Syscall code                      |
| `r24`   | `t3`   | Temporary                         |
| `r25`   | `t4`   | Temporary                         |
| `r26`   | `t5`   | Temporary                         |
| `r27`   | `t6`   | Temporary                         |
| `r28`   | `x28`  | Reserved / custom use             |
| `r29`   | `x29`  | Reserved / custom use             |
| `r30`   | `x30`  | Reserved / custom use             |
| `r31`   | `x31`  | Reserved / custom use             |

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- –ê—Å—Å–µ–º–±–ª–µ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä–æ–≥–æ–π –º–æ–¥–µ–ª–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π. –í—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫ –Ω–∏–º —Ñ—É–Ω–∫—Ü–∏–π
- –Ø–∑—ã–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤–∫–ª—é—á–∞—é—â–∏–µ –≤ —Å–µ–±—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Ä–∏—Ñ./–ª–æ–≥–∏—á. –æ–ø–µ—Ä–∞—Ü–∏–π. –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç
- –í—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -- –ª–∏–±–æ —Ä–µ–≥–∏—Å—Ç—Ä—ã, –ª–∏–±–æ –ø—Ä–æ—Å—Ç—ã–µ –Ω–µ–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–ª–∏—Ç–µ—Ä–∞–ª—ã), –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –Ω–∞ —ç—Ç–∞–ø–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
- –í—Å–µ –ø—Å–µ–≤–¥–æ-—Ñ—É–Ω–∫—Ü–∏–∏ (high(label), low(label)) —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏. –í–æ –≤—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

### –û–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
–í —è–∑—ã–∫–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–∞–∫ —Ç–∞–∫–æ–≤—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏, –æ–¥–Ω–∞–∫–æ –µ—Å—Ç—å –ø–∞—Ä–∞ –º–æ–º–µ–Ω—Ç–æ–≤:
- –°–µ–∫—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–º–∞–Ω–¥ –Ω–µ –∏–º–µ—é—Ç –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É
- –ù–∞ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–º —É—Ä–æ–≤–Ω–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –∏–∑ –ø–∞–º—è—Ç–∏ –∫–æ–º–∞–Ω–¥ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
- –ú–µ—Ç–∫–∏ (label:) –∏–º–µ—é—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–µ–∫—Ü–∏–∏, –≤ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ä—è–≤–ª–µ–Ω—ã
- –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏ –º–µ—Ç–∫–æ–π, –∏ –º–∞–∫—Ä–æ—Å–æ–º, –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –Ω–∞ —ç—Ç–∞–ø–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ (–Ω–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)

### –¢–∏–ø–∏–∑–∞—Ü–∏—è, –≤–∏–¥—ã –ª–∏—Ç–µ—Ä–∞–ª–æ–≤
- .word ‚Äî 32-–±–∏—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- .byte ‚Äî 8-–±–∏—Ç–Ω—ã–µ
- 0x –ª–∏—Ç–µ—Ä–∞–ª—ã
- –ø—Å–µ–≤–¥–æ-—Ñ—É–Ω–∫—Ü–∏–∏ high(), low()

## –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
- –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞–º—è—Ç—å —Å –±–∞–π—Ç–æ–≤–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π.
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (lw, sw) —Ä–∞–±–æ—Ç–∞—é—Ç —Å 4-–±–∞–π—Ç–æ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.
- –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–º–µ—â–µ–Ω–∏—è –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö –ø–∞–º—è—Ç–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π 12-–±–∏—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ –∑–Ω–∞–∫–æ–º, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ +-2048 –±–∞–π—Ç–∞–º –≤–æ–∫—Ä—É–≥ –±–∞–∑–æ–≤–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞.
- –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ì–∞—Ä–≤–∞—Ä–¥—Å–∫–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç 3 –≤–∏–¥–∞ –ø–∞–º—è—Ç–∏: –ü–∞–º—è—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π, –ü–∞–º—è—Ç—å –¥–∞–Ω–Ω—ã—Ö, –ü–∞–º—è—Ç—å –º–∏–∫—Ä–æ–∫–æ–º–∞–Ω–¥

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–∫—Ä–æ–∫–æ–¥–∞

–ö–∞–∂–¥–∞—è –º–∏–∫—Ä–æ–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (`MicroInstruction`) –∑–∞–¥–∞—ë—Ç –æ–¥–∏–Ω —Ç–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –ø–æ–ª—è –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ:

|    –ü–æ–ª–µ     |       –¢–∏–ø       |       –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è       |                         –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                          |
| :---------: | :-------------: | :----------------------------: | :---------------------------------------------------------: |
| `latch_pc`  | `Optional[str]` |  `"inc"`, `"alu"`, `"branch"`  | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PC: –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç, –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ ALU, —É—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ |
| `latch_ir`  |     `bool`      |        `True` / `False`        |        –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏–∑ –ø–∞–º—è—Ç–∏ –ø–æ `PC` –≤ `IR`        |
| `latch_reg` | `Optional[int]` |            `0..31`             |        –ù–æ–º–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∑–∞–ø–∏—Å—å        |
| `latch_alu` | `Optional[str]` | `"add"`, `"sub"`, ..., `"lui"` |         ALU-–æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞         |
| `latch_ar`  | `Optional[str]` |               ‚Äî                |              –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)              |
| `mem_read`  |     `bool`      |        `True` / `False`        |      –°—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ `data_mem` –ø–æ –∞–¥—Ä–µ—Å—É `ALU_OUT`       |
| `mem_write` |     `bool`      |        `True` / `False`        |      –ó–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ `data_mem` –ø–æ –∞–¥—Ä–µ—Å—É `ALU_OUT`       |
| `set_flags` |     `bool`      |        `True` / `False`        |     –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥–∏ `Z`, `N` –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ALU      |
| `next_mpc`  | `Optional[int]` |       –∞–¥—Ä–µ—Å –º–∏–∫—Ä–æ–∫–æ–º–∞–Ω–¥—ã       |        –ê–¥—Ä–µ—Å —Å–ª–µ–¥—É—é—â–µ–π –º–∏–∫—Ä–æ–∫–æ–º–∞–Ω–¥—ã –≤ –º–∏–∫—Ä–æ–ø—Ä–æ–≥—Ä–∞–º–º–µ        |
|  `jump_if`  | `Optional[str]` | `"Z"`, `"NZ"`, `"GT"`, `"LE"`  |         –£—Å–ª–æ–≤–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ (–¥–ª—è `latch_pc="branch"`)          |
|   `halt`    |     `bool`      |        `True` / `False`        |                –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—à–∏–Ω—ã                 |
              |

#### –ù–∞—á–∞–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ–∫–æ–º–∞–Ω–¥—ã

| MPC  | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π       |                         –û–ø–∏—Å–∞–Ω–∏–µ                          |
| ---- | ----------------- | :-------------------------------------------------------: |
| 0    | `FETCH`           |     –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–∞–Ω–¥—ã –∏–∑ `instr_mem` –≤ `IR`, `PC += 4`     |
| 1    | `DECODE`          |            –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–±—â–µ–π —Ç–æ—á–∫–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è            |
| 1000 | `DECODE DISPATCH` | –ü–æ–∏—Å–∫ –Ω—É–∂–Ω–æ–π –º–∏–∫—Ä–æ–ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ `(opcode, funct3, funct7)` |


### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ–≥—Ä–∞–º–º (PC) —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—É—é –ø–∞–º—è—Ç—å.
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–º–µ—é—Ç –¥–ª–∏–Ω—É 4 –±–∞–π—Ç–∞ (32 –±–∏—Ç–∞) –∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ —Å–ª–æ–≤–∞–º.
- –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç PC –Ω–∞ += 4 –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Ö–æ–¥.

### –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
- –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–∞–º—è—Ç–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä—ã: –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (lw, sw) —Ç—Ä–µ–±—É—é—Ç –∞–¥—Ä–µ—Å –≤ —Ä–µ–≥–∏—Å—Ç—Ä–µ.
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è lw (load word) –∑–∞–≥—Ä—É–∂–∞–µ—Ç 4 –±–∞–π—Ç–∞ –∏–∑ –ø–∞–º—è—Ç–∏ –ø–æ –∞–¥—Ä–µ—Å—É, —Å–æ–¥–µ—Ä–∂–∞—â–µ–º—É—Å—è –≤ —Ä–µ–≥–∏—Å—Ç—Ä–µ.
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è sw (store word) –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç 4 –±–∞–π—Ç–∞ –ø–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–º—É –∞–¥—Ä–µ—Å—É.
- –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ lw/sw ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ lui/addi –∏–ª–∏ –∞–¥—Ä–µ—Å–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã.
- I\O –∞–¥—Ä–µ—Å–∞ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å—Ç—Ä–æ–≥–∏–µ: input -- 0x1, output -- 0x2. –í –±—É–¥—É—â–µ–º —É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –±—É–¥–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∞–º–æ–º—É –≤—ã–±–∏—Ä–∞—Ç—å —ç—Ç–∏ –∞–¥—Ä–µ—Å–∞

```
       Instruction memory
        +-----------------------------+
        |      Instruction Memory     |  <-- –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ (READ-ONLY)
        | 0x0000: bin instr           |
        | 0x0004: bin instr           |
        |  ...                        |
        +-----------------------------+

        +-----------------------------+
        |         Data Memory         |  <-- –ß—Ç–µ–Ω–∏–µ / –ó–∞–ø–∏—Å—å
        | 0x1000: user data           |
        | 0x1004: user data           |
        |  ...                        |
        +-----------------------------+

        +-----------------------------+
        |      Memory-mapped I/O      |
        | 0x1: IN_BUF                 |  <-- –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
        | 0x2: OUT_BUF                |  <-- –¢–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å
        +-----------------------------+

        +-----------------------------+
        |     Microprogram Memory     |  <-- –¢–æ–ª—å–∫–æ CU, —Å–∏–≥–Ω–∞–ª—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        | 0x0000: signals             |
        | 0x0001: signals             |
        |  ...                        |
        +-----------------------------+

```

## –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∞–Ω–¥
#### –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä—Å—Ç–∏–∫–∏ (features):
 - –î–ª–∏–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å—Ç—Ä–æ–≥–∞—è, 32 –±–∏—Ç
 - –ó–Ω–∞—á–µ–Ω–∏—è `opcode` –∏ —Ñ–æ—Ä–º–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤–∑—è—Ç—ã –∏–∑ –æ—Ñ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ RISC-V
 - `jal` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä—è–º–æ –∫–∞–∫ –≤ RISC-V, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å —É—á—ë—Ç–æ–º r0 –∫–∞–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ `jal` –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ `goto <label>` –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ —Ä–µ–≥–∏—Å—Ç—Ä –≤–æ–∑–≤—Ä–∞—Ç–∞. –î–∏–∞–ø–∞–∑–æ–Ω –∑–Ω–∞—á–µ–Ω–∏–π, —Ç–∞–∫ –∫–∞–∫ `imm value` 20 –±–∏—Ç –±—É–¥–µ—Ç `[-2^31; 2^31 - 2^12] = [‚àí2147483648, 2147479552]`
 - –ù–∞ –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É —É—Ö–æ–¥–∏—Ç –º–∏–Ω–∏–º—É–º 2 —Ç–∞–∫—Ç–∞ –Ω–∞ fetch –∏ decode, –¥–∞–ª—å—à–µ, –≤ –∑–∞–≤–∏—Å-—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–∏–∫—Ä–æ–ø—Ä–æ–≥—Ä–∞–º–º—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç 1 –¥–æ ~3 –º–∏–∫—Ä–æ–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

#### –ê–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã:
- rs - source register
- rd - destination register
- opcode - operation code
- funct - function fields
- imm - immediate value 


|  Type  |       Example Instructions       | Opcode (bin) | Opcode (hex) |            Notes            |
| :----: | :------------------------------: | :----------: | :----------: | :-------------------------: |
| R-type | add, sub, mul, div, and, or, xor |  `0110011`   |    `0x33`    |   ALU register operations   |
| I-type |         addi, andi, ori          |  `0010011`   |    `0x13`    |      ALU immediate ops      |
| I-type |              lw, lb              |  `0000011`   |    `0x03`    |      Load instructions      |
| I-type |               jalr               |  `1100111`   |    `0x67`    |        Indirect jump        |
| S-type |                sw                |  `0100011`   |    `0x23`    |     Store instructions      |
| B-type |        beq, bne, blt, bge        |  `1100011`   |    `0x63`    |    Conditional branches     |
| U-type |               lui                |  `0110111`   |    `0x37`    |    Load upper immediate     |
| U-type |              auipc               |  `0010111`   |    `0x17`    | PC-relative upper immediate |
| J-type |               jal                |  `1101111`   |    `0x6F`    |  Unconditional jump + link  |
|  SYS   |               halt               |  `1111111`   |    `0x7F`    |     Custom system/halt      |

* `opcode` ‚Äî –≤—Å–µ–≥–¥–∞ –≤ `[6..0]`
* `funct3` ‚Äî –≤—Å–µ–≥–¥–∞ –≤ `[14..12]`
* `funct7` (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –≤—Å–µ–≥–¥–∞ –≤ `[31..25]`

---
#### R-type –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–§–æ—Ä–º–∞—Ç:

|  funct7  |   rs2    |   rs1    |  funct3  |   rd    | opcode |
| :------: | :------: | :------: | :------: | :-----: | :----: |
| [31..25] | [24..20] | [19..15] | [14..12] | [11..7] | [6..0] |


–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:

| Instruction | funct7  | funct3 | opcode (0x33) |    Description    |
| :---------: | :-----: | :----: | :-----------: | :---------------: |
|     add     | 0000000 |  000   |    0110011    | `rd = rs1 + rs2`  |
|     sub     | 0000000 |  001   |    0110011    | `rd = rs1 - rs2`  |
|     and     | 0000000 |  010   |    0110011    | `rd = rs1 & rs2`  |
|     or      | 0000000 |  011   |    0110011    | `rd = rs1 \| rs2` |
|     xor     | 0000000 |  100   |    0110011    | `rd = rs1 ^ rs2`  |
|     mul     | 0000000 |  101   |    0110011    | `rd = rs1 * rs2`  |
|     div     | 0000000 |  110   |    0110011    | `rd = rs1 / rs2`  |
|     lsl     | 0000000 |  111   |    0110011    | `rd = rs1 << rs2` |
|     lsr     | 0000001 |  000   |    0110011    | `rd = rs1 >> rs2` |

---

#### I-type –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–§–æ—Ä–º–∞—Ç:

| imm[11:0] |   rs1    |  funct3  |   rd    | opcode |
| :-------: | :------: | :------: | :-----: | :----: |
| [31..20]  | [19..15] | [14..12] | [11..7] | [6..0] |

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:

| Instruction | funct3 | opcode  |                   Description                    |
| :---------: | :----: | :-----: | :----------------------------------------------: |
|    addi     |  000   | 0010011 |                 `rd = rs1 + imm`                 |
|    andi     |  001   | 0010011 |                 `rd = rs1 & imm`                 |
|     ori     |  010   | 0010011 |                `rd = rs1 \| imm`                 |
|     lw      |  000   | 0000011 |   `rd = 32-bit word at mem[rs1 + offset]<br>`    |
|     lb      |  001   | 0000011 | ``rd ‚Üê sign-extended byte at mem[rs1 + offset]`` |
|    jalr     |  000   | 1100111 |            `PC = (rs1 + offset) & ~1`            |


---
#### S-type –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–§–æ—Ä–º–∞—Ç:

| imm[11:5] |   rs2    |   rs1    |  funct3  | imm[4:0] | opcode |
| :-------: | :------: | :------: | :------: | :------: | :----: |
| [31..25]  | [24..20] | [19..15] | [14..12] | [11..7]  | [6..0] |

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:


| Instruction | funct3 | opcode  |         Description          |
| :---------: | :----: | :-----: | :--------------------------: |
|     sw      |  000   | 0100011 |    `mem[rs1 + imm] = rs2`    |
|     sb      |  001   | 0100011 | `byte at mem[rs1+imm] = rs2` |

---
#### B-type –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–§–æ—Ä–º–∞—Ç:

| imm[12] | imm[10:5] |   rs2    |   rs1    |  funct3  | imm[4:1] | imm[11] | opcode |
| :-----: | :-------: | :------: | :------: | :------: | :------: | :-----: | :----: |
|  [31]   | [30..25]  | [24..20] | [19..15] | [14..12] | [11..8]  |   [7]   | [6..0] |


> –ü–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –≤—Å–µ —á–∞—Å—Ç–∏ immediate —Å–∫–ª–µ–∏–≤–∞—é—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ 12-–±–∏—Ç–Ω—ã–π —Å–º–µ—â—ë–Ω–Ω—ã–π offset


–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:

| Instruction | funct3 | opcode  |          Description          |
| :---------: | :----: | :-----: | :---------------------------: |
|     beq     |  000   | 1100011 | `if rs1 == rs2, PC += offset` |
|     bne     |  001   | 1100011 | `if rs1 != rs2, PC += offset` |
|     bgt     |  010   | 1100011 | `if rs1 > rs2, PC += offset`  |
|     ble     |  011   | 1100011 | `if rs1 <= rs2, PC += offset` |

---
#### U-type –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–§–æ—Ä–º–∞—Ç:

| imm[31:12] |   rd    | opcode |
| :--------: | :-----: | :----: |
|  [31..12]  | [11..7] | [6..0] |

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:

| Instruction | opcode  |   Description    |
| :---------: | :-----: | :--------------: |
|     lui     | 0110111 | `rd = imm << 12` |

---

#### J-type –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–§–æ—Ä–º–∞—Ç:

| imm[20] | imm[10:1] | imm[11] | imm[19:12] |   rd    | opcode |
| :-----: | :-------: | :-----: | :--------: | :-----: | :----: |
|  [31]   | [30..21]  |  [20]   |  [19..12]  | [11..7] | [6..0] |
> –ü–æ—Å–ª–µ —Å–∫–ª–µ–π–∫–∏: `offset = {imm[20], imm[10:1], imm[11], imm[19:12]} << 1`

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:

| Instruction | opcode  |          Description          |
| :---------: | :-----: | :---------------------------: |
|     jal     | 1101111 | `rd = PC+4; PC = PC + offset` |

---
#### sys-type

–§–æ—Ä–º–∞—Ç

| instruction | operands | opcode (bin) | opcode (hex) |    description     |
| :---------: | :------: | :----------: | :----------: | :----------------: |
|   `halt`    |    ‚Äì     |  `1111111`   |    `0x7F`    | Custom system/halt |

## –¢—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä

–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤:

1. **–ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ö–æ–¥ (`first_pass`)**  
   - –ü—Ä–æ–ø—É—Å–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (`#`).
   - –ö–æ–¥ —Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ–∫—Ü–∏–∏ `.text` –∏ `.data`, –∫–∞–∂–¥–∞—è —Å–æ —Å–≤–æ–µ–π –æ–±–ª–∞—Å—Ç—å—é –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ (—Ç–∞–∫ –∫–∞–∫ –ì–∞—Ä–≤–∞—Ä–¥—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞).
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤ `.org`.
   - –í—ã–¥–µ–ª—è—é—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ—Ç–∫–∏ (labels) –≤–º–µ—Å—Ç–µ —Å –∏—Ö –∞–¥—Ä–µ—Å–∞–º–∏.
   - –§–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –¥–≤–∞ —Å–µ–≥–º–µ–Ω—Ç–∞: `data_segment` –∏ `text_segment`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –ø–∞—Ä—ã `(–∞–¥—Ä–µ—Å, —Å—Ç—Ä–æ–∫–∞`.

2. **–í—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥ (`second_pass`)**  
   –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è:
   - –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —á–∏—Å–ª–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
   - –ú–µ—Ç–∫–∏ —Å `.word` –∏ `.byte` —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—Ç—Å—è –≤ –ø–∞–º—è—Ç—å, –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ø–æ –∞–¥—Ä–µ—Å—É `out/<out_path>.data.bin`
   - –î–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π `.text` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ä—Å–µ—Ä (`parse_line`) –∏ —ç–Ω–∫–æ–¥–µ—Ä (`encode`), –∫–æ—Ç–æ—Ä—ã–π —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç 32-–±–∏—Ç–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π –∫–æ–¥ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º ISA.
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: `(–∞–¥—Ä–µ—Å, –∏—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞, –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–¥)`.

3. **–í—ã–≤–æ–¥ –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`write_binaries`)**  
   - –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–∞:  
     - `.text.bin` ‚Äî –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)  
     - `.data.bin` ‚Äî –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–∞–Ω–Ω—ã—Ö  
   - –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–º–ø—ã `.text.log` –∏ `.data.log`, –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç:  
     `–∞–¥—Ä–µ—Å ‚Äî HEX ‚Äî BIN ‚Äî –∏—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞`.

## –ú–æ–¥–µ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
__RISC, lol?__
> –ù–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (—á–µ—Ä–µ–∑ [translator.py](machine/translator.py)) –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª, –≤—ã—Ö–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Ñ–∞–π–ª —Å –≤—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

–ò–∑ [run_machine.py](run_machine.py):
```text
Usage: python run_machine.py <text_bin> <data_bin> [input_file]
```

–ó–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–∞:
```text
Usage: python machine/translator.py <asm file> <desired output file name>
```

–≠–º—É–ª—è—Ç–æ—Ä –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ (–≤ `trace.log`) —Å –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
- –Ω–æ–º–µ—Ä —Ç–∞–∫—Ç–∞;
- —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤;
- IR, PC, ALU_OUT, —Ñ–ª–∞–≥–∏;
- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º CU.
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–æ—á–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–∏–∫—Ä–æ–∫–æ–º–∞–Ω–¥.

### –°—Ö–µ–º–æ—Ç–µ—Ö–Ω–∏–∫–∞
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏:
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã (32 –±–∏—Ç–∞);
- 7 —Ç–∏–ø–æ–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π (R, I, S, B, U, J, SYS);
- –ü–∞–º—è—Ç—å Harvard-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∏ –¥–∞–Ω–Ω—ã—Ö);
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –æ—Ç–æ–±—Ä–∞–∂—ë–Ω–Ω—É—é –ø–∞–º—è—Ç—å (memory-mapped I/O);
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–ª–∞–≥–æ–≤ (N, Z).

#### Datapath

Datapath —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
- —Ä–µ–≥–∏—Å—Ç—Äa –∫–æ–º–∞–Ω–¥ (IR);
- —Ä–µ–≥–∏—Å—Ç—Äa —Å—á—ë—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥ (PC);
- ALU (–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–æ-–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ);
- —Ä–µ–≥–∏—Å—Ç—Äo–≤ –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (32 x 32-–±–∏—Ç–Ω—ã—Ö);
- –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–æ—Ä–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ö–æ–¥–æ–≤ ALU –∏ –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏;
- —à–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∞–¥—Ä–µ—Å–æ–≤.

![Datapath](lab4_Datapath.png)

---

#### Control Unit

Control Unit —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ –º–∏–∫—Ä–æ–ø—Ä–æ–≥—Ä–∞–º–º–Ω—É—é –ø–∞–º—è—Ç—å, –≥–¥–µ –∫–∞–∂–¥–∞—è –º–∏–∫—Ä–æ–∫–æ–º–∞–Ω–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç:
   - —Å–∏–≥–Ω–∞–ª—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å, –≤—ã–±–æ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞, –æ–ø–µ—Ä–∞—Ü–∏–∏ ALU);
   - –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –º–∏–∫—Ä–æ–∫–æ–º–∞–Ω–¥–µ;
   - —É—Å–ª–æ–≤–∏—è –≤–µ—Ç–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–ª–∞–≥–æ–≤ N/Z –∏ —Ç–∏–ø–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

–ú–∏–∫—Ä–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–æ—á–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —Ç–∞–∫—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

![Control Unit](lab4_CU.drawio.png)


## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –≤–∏–¥–µ **golden tests** ‚Äî —Ç–æ –µ—Å—Ç—å –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π `.asm`-—Ñ–∞–π–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è —Å –∑–∞—Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ **—ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏** (–ª–æ–≥–∏, —Å–Ω–∏–º–∫–∏ –ø–∞–º—è—Ç–∏ –∏ —Ç.–¥.).

### üîß –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:

* [`pytest`](https://docs.pytest.org/) ‚Äî –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∞–º–∏;
* [`GitHub Actions`](https://docs.github.com/en/actions) ‚Äî –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ CI –Ω–∞ –∫–∞–∂–¥—ã–π `push` –∏ `pull request`;
* `tests/expected/<name>/` ‚Äî –ø–∞–ø–∫–∏ —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ (–∑–æ–ª–æ—Ç—ã–º–∏) –ª–æ–≥–∞–º–∏;
* `test_outputs/<name>/` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–≥–∏ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞ (–≤—Å–µ–≥–¥–∞), –¥–∞–∂–µ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏.

---

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ:

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞:

1. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è `.asm` -> `.bin`;
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `run_machine.py` –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö;
3. –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
   * `trace.log` (–º–∏–∫—Ä–æ—à–∞–≥–∏ CU);
   * `final_snapshot.txt` (—Å–Ω–∏–º–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ –∏ –ø–∞–º—è—Ç–∏);
   * `out.text.log` (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ hex –∏ –¥–∏–∑–∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ);
   * `out.data.log` (–¥–∞–º–ø —Å–µ–∫—Ü–∏–∏ `.data`);
4. –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è —Å `tests/expected/<test>/`.

---

### üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤—Ä—É—á—É—é

–í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```bash
pytest -v
```

–¢–µ—Å—Ç—ã –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ñ–∞–π–ª–æ–º –∏–ª–∏ —Ç–µ—Å—Ç–æ–º:

```bash
pytest tests/test_algorithms.py::test_algorithm[hello_world]
```

---

### üíö CI: GitHub Actions

–ù–∞—Å—Ç—Ä–æ–µ–Ω CI workflow `.github/workflows/test.yml`:

* –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º `push` –∏–ª–∏ `pull_request`;
* —Å–æ–±–∏—Ä–∞–µ—Ç –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ `.asm`-—Ñ–∞–π–ª—ã;
* –ø–∞–¥–∞–µ—Ç, –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º.